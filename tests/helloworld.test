# vi: filetype=sh

function build_helloworld {
    build_squashapp --embed ../examples/helloworld "$@"
}

for shell in shells/*; do
    export SQUASHAPP_SHELL="${shell}"/sh
    PREFIX="$(basename "${shell}")"

    if ! [[ -x "${SQUASHAPP_SHELL}" ]]; then
        continue
    fi

    TEST "${PREFIX}_default"; DO $(
        trap 'rm -f *.squashs *.run || true' EXIT

        assert_ok build_helloworld
        assert_eq "$(./helloworld.run)" "Hello, world!"
        assert_eq "$(./helloworld.run Bob)" "Hello, Bob!"
    );

    TEST "${PREFIX}_custom_main"; DO $(
        trap 'rm -f *.squashs *.run || true' EXIT

        assert_ok build_helloworld bin/helloworld
        assert_eq "$(./helloworld.run)" "Hello, world!"
        assert_eq "$(./helloworld.run Joe)" "Hello, Joe!"
    )

    TEST "${PREFIX}_absolute_main_is_error"; DO $(
        trap 'rm -f *.squashs *.run || true' EXIT

        assert_err build_helloworld /bin/helloworld
    )

    TEST "${PREFIX}_external_main_is_error"; DO $(
        trap 'rm -f *.squashs *.run || true' EXIT

        assert_err build_helloworld /bin/true
    )

    TEST "${PREFIX}_missing_main_is_error"; DO $(
        trap 'rm -f *.squashs *.run || true' EXIT

        assert_err build_helloworld bin/nosuchfile
    )

    unset SQUASHAPP_SHELL
    unset PREFIX
done

TEST bad_shell_is_error; DO $(
    trap 'rm -f *.squashs *.run || true' EXIT

    SQUASHAPP_SHELL=/bin/false assert_ok build_helloworld
    assert_err ./helloworld.run
)
